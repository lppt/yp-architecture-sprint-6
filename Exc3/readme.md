# Задание 3. Переход на Event-Driven архитектуру

## Проблемы

- Сервис синхронно опрашивает 5 внешних API в момент запроса.
  Это затрудняет ответ т.к.

1. Мы идем со скоростью самого медленного бизона
2. Ошибки в любом сервисе могут спровоцировать падение всего запроса

- Ночью (не понятно в каком поясе) происходит полная синхронизация заявок. При возникновении ошибок видимо приходится будить специалистов поддержки. Лучше этот процесс размазать в течении дня и убрать сильную зависимость сервисов друг от друга.

## Риски

При увеличении количества внешних API возрастает вероятность возникновения ошибок, ровно как и замедляется общая скорость работы.

Ошибки во взаимодействии не могут быть своевременно отработаны.

Сбои во внешнем api могут приводить к проблемам всего приложения.

## Что будем делать?

Естественно переводим взаимодействие в асинхронный режим.
Поднимаем kaffka, заводим там 3 топика

1. Для изменений по продуктам и тарифам
2. Для отправки оформленных заявок
3. Для отправки результатов оформления

### Transactional Outbox

1. Изменения по продуктам и тарифам - т.к. эти данные меняются периодически и их всегда можно перезапросить, то их можно считать "не критическими", так что тут можно обойтись идемпотентностью и не вводить дополнительную бд
2. Отправка оформленных заявок - это штука важная, если мы потеряем заявку пользователя, то страховка по факту не будет оформлена. Тут прям надо.
3. Результаты оформления. Тут не обязательно, но желательно.
   С одной стороны у нас эти данные всегда есть в доступе под сервисом ins-comp-settlement, а core-app они нужны всего раз в день. Так что как вариант можно отправлять какой то документ сверки раз в час и если есть расхождения, то переотправить события за последний интервал. Но если проще сделать transactional outbox, то можно и его
